<html>
    <head>
        <link rel="stylesheet" href="../common/css/style.css" />
        <link rel="stylesheet" href="./style.css" />
    <style>
    #example {
        padding: 1em;
    }

    </style>
    </head>

    <body>
        <div id="example">
            <div>
                <p>This is an exmple of creating child windows.</p>
                <p>2 child windows are created when you click Start</p>
                <p>You can use the slider and text input in the Control window
                    to change the text displayed in the Draw window.
                </p>
                <p>This window listens to Control elements and updates Draw elements.</p>
                <p>Child window positions are saved and restored.</p>
                <p>When either window is closed manually, the other is also closed.</p>
                <p>There is a simple example at <a href='../child-windows-simple/index.html'>more advanced example.</a></p>
            </div>
            <div>
                <div>Press start to create windows</div>
                <button id="start">Start</button>
            </div>
            <div class="hide">
                <div>Press stop to close windows</div>
                <button id="stop">Stop</button>
                <div class="child-status draw-window-status"></div>
                <div class="child-status control-window-status"></div>
            </div>
        </div>
    </body>
    </html>
    <script type="module">
        import { createChildWindow } from './child-windows.js';
        import { createLogger } from './logger.js';
        import {createLogManager } from './log-manager.js';

        alert("The can be problems reinitializing when the page is refreshed.  Open in a new window if it doesn't work.");

        const logManager = await createLogManager();
        let log = createLogger("Main");
        log.debug("Running");
        log.info("info message");
        log.warn("warn message");
        log.error("error message");
        let controlWindow = null;
        let drawWindow = null;

        const stopButton = document.getElementById('stop');
        const startButton = document.getElementById('start');

        function rotateText(event) {
            const value = event.target.value-180;
            log.info(`rotate: ${value}`);

            const textElement = drawWindow.querySelector('.draw-text');
            const transform = `rotate(${value}deg)`;
            textElement.style.transform = transform;

        }

        function changeText(event) {
            const value = event.target.value;
            log.info(`change text: ${value}`);
            const textElement = drawWindow.querySelector('.draw-text');
            textElement.innerText = value;
        }

        function createControlListeners(){
            controlWindow.querySelector(`input[name='rotation']`)
                        .addEventListener('input',rotateText);
            controlWindow.querySelector(`input[name='text']`)
                        .addEventListener('input', changeText);
        }

        function closeWindows() {
            log.info("close windows");
            controlWindow?.close();
            drawWindow?.close();
            startButton.parentElement.classList.remove('hide');
            stopButton.parentElement.classList.add('hide');
        }

        async function openWindows() {
            log.info("open windows");

            drawWindow = await createChildWindow("Draw", "draw.html");
            controlWindow = await createChildWindow("Control", "control.html");
            createControlListeners();
            startButton.parentElement.classList.add('hide');
            stopButton.parentElement.classList.remove('hide');

            drawWindow.addCloseHandler(closeWindows);
            controlWindow.addCloseHandler(closeWindows);
        }

        startButton.addEventListener('click',()=>{
            closeWindows();
            openWindows();
        });

        stopButton.addEventListener('click', () => {
            closeWindows();
        });

        window.addEventListener('beforeunload', () => {
            try {
                console.log('closing');
                logManager?.close();
                controlWindow?.close();
                drawWindow?.close();
                console.log('child windows closed');
                return true;
            } catch (ex) {
                console.log("cannot close windows ",ex);
            }
            });


    </script>
</html>